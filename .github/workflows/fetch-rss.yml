name: Fetch RSS and publish JSON

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install node-fetch@3

      - name: Fetch via rss2json
        env:
          RSS2JSON_API_KEY: ${{ secrets.RSS2JSONAPIKEY }}
          RSS_URL: "https://www.tagesschau.de/xml/rss2"
          COUNT: "20"
        run: |
          node -e '
          import fetch from "node-fetch";
          const key   = process.env.RSS2JSON_API_KEY || "";
          const rss   = encodeURIComponent(process.env.RSS_URL);
          const count = process.env.COUNT || "20";

          const params = new URLSearchParams({ rss_url: rss, count });
          if (key) params.append("api_key", key);

          const url = `https://api.rss2json.com/v1/api.json?${params.toString()}`;
          console.log("[fetch]", url.replace(/api_key=[^&]+/, "api_key=***"));

          const res = await fetch(url);
          if (!res.ok) throw new Error("rss2json HTTP " + res.status);

          const data = await res.json();
          if (data.status !== "ok") throw new Error(data.message || "unknown");

          const items = (data.items || []).map(x => ({ title: x.title, link: x.link }));
          const out = { items };
          await (await import("node:fs/promises")).writeFile("feed.json", JSON.stringify(out, null, 2));
          console.log("[write] feed.json ->", items.length, "items");
          '

      - name: Commit feed.json
        run: |
          git config user.name  github-actions
          git config user.email github-actions@users.noreply.github.com
          git add feed.json
          git commit -m "update feed.json [skip ci]" || echo "no changes"
          git push
